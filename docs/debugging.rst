Debugging
=========

Possible model errors
^^^^^^^^^^^^^^^^^^^^^
Outline the problem and then any symptoms
You are altering the original inputs because you have operated on a view not a copy.
Run one trial and it works fine, run multiple trials that should be the same and they are not
The model is inconsistently deciding to run pyomo ie the parameters are different but they should be the same
Model is not selecting any livestock.
Symptoms: Reducing the number of nutrition options causes no sheep or changing the feedsupply causes no sheep.
Solution: This problem is likely caused by dams not being able to provide enough prog to replace themselves. This is because the weight distributions don't align and prog will be getting lost (eg initial dam weights are not similar enough to the prog weights so the prog are not able to provide dams). To fix this you can alter the initial lw of the dams (property inputs: i_adjp_lw_initial_w1).


Process to debug
^^^^^^^^^^^^^^^^
Simplify the model as much as possible to make it easier to debug (reduce TOL options, reduce lw patterns, reduce genotypes etc).
Check the variable summary. This will point out any obvious issues and help to determine where to start looking.
To locate where the problem is you can often just comment out constraints until the model solves. This can further indicate where to look.
Go back to the last working version (using the power of git) and compare outputs with current. If you have some idea where the issue is you can even compare the params between the two versions to see if something jumps out.
Once you have an idea where the problem is you can look in more detail using:
The lp file.
The params dictionary.
The arrays (assessable in debug mode). 

Solving an infeasible model
^^^^^^^^^^^^^^^^^^^^^^^^^^^
If the model is infeasible then solving the model through the code does not return a solution. If the model is run from the command prompt then the option “--nopresol” can be included and a result file will be created.

Open a command prompt, change to the AFO directory that contains the test.lp (where test.lp is the lp file generated by pyomo before solving - the line to do this must be uncommented) file that was created from the code and type the command:

C:\Models\AFO>glpsol --lp --nopresol test.lp --output resultfile

It will generate a screen report of solver info and create a file resultfile (or whatever name was specified) in the AFO directory.

Infeasible model
This was caused once by having a very small negative number (-2e-16) returned from the crop sim (sometimes python returns a small negitive number instead of 0), the solver clearly didn’t like it (even though i thought it would just be treated as a 0 or as a small value)
The model has before not solved returning ‘other’ as the solver status. This may be caused by the solver stalling. Check SA values dont have too many decimals (this may have been an issue once).

Pyomo
^^^^^
Speed
Parameters: initialization of large parameters can take time (for example in the stock module). To save time mask out the 0 values when creating the param dict and set default argument in the parameter to 0. This make it quicker to build the dictionary in the first place and makes it much faster to initilise the parameter in pyomo (see stock pyomo for examples of this)

Constraints: building constraints can be slow however efficiency can be improved by using if statement which reduce the summing required. Additionally in certain circumstances (eg stock numbers) you can alter the parameters so that duplicate constraints are not built and then use the constraint.skip method to jump over.
It takes longer than I would have expected to evaluate if statements when building a pyomo constraint so time can be saved when summing by only evaluating required items in the if statement/s.

Errors
1)
ERROR: evaluating object as numeric value: v_phase_area[GAANw,lmu1]
        (object: <class 'pyomo.core.base.var._GeneralVarData'>)
    No value for uninitialized NumericValue object v_phase_area[GAANw,lmu1]
You are most likely trying to evaluate an equation with a variable, variables don’t have a value at this time hence the error ie trying to do a conditional statement on an equation

2)
Error: Constraint resulting in boolean
Often because param is default to 0 and that is multiplying by other stuff in the equation therefore overall results is 0. 
Can fix by using if statement to cut out that constrain and use Constraint.Skip (example of this is con_stubble_a in coremodel.py)

3)
ERROR: Solver (glpk) returned non-zero return code (1)
ERROR: See the solver log above for diagnostic information.
-this may be due to an inf number as a param

4)
Error: cant evaluate a quadratic
GLPK can’t evaluate a formula where one variable is being multiplied by another variable. Often to solve this you may need to add a variable and make a transfer constraint.
5)
No value for uninitialized NumericValue object v_credit[ND$FLOW]
This means the solver returned a no feasible solution
This was caused once by having a very small negative number (-2e-16) returned from the crop sim (sometimes python returns a small negitive number instead of 0), the solver clearly didn’t like it (even though i thought it would just be treated as a 0 or as a small value)
6) infeasible model:
	-remove constraints to see which is causing infeasibility
	- remove bounds (overdraw, erosion limit, labour, sr, rotation area
7) Writing full solution: No value for uninitialized NumericValue object
This means a variable has None as its value. This can happen for some variables eg sheep which have been masked out and hence are not really included in the model. When writing the full model the constraints are evaluated. This can cause errors if variables have None value. To fix this error you should skip building constraints which are not required.
In my case the upper bound on dams numbers constraint was throwing an error. To fix the problem i skipped the constraints when upper bound was equal to inf (eg when the bound was not doing anything). 




   



